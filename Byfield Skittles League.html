<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Byfield Skittles League + Highest Scores</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background: #f4f4f4; 
    line-height: 1.6;
  }
  h1 { 
    text-align: center; 
    color: #00332e; 
    margin-bottom: 10px; 
    font-size: 2.2rem;
  }
  h2 { 
    text-align: center; 
    color: #006f62; 
    margin: 40px 0 15px; 
  }
  .table-container { 
    overflow-x: auto; 
    margin-bottom: 30px; 
  }
  table { 
    border-collapse: collapse; 
    background: white; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.15); 
    width: 100%; 
    table-layout: fixed;
  }
  th, td { 
    padding: 12px 8px; 
    text-align: center; 
    border: 1px solid #aaa; 
    vertical-align: middle !important; 
  }
  th { background: #006f62; color: white; font-weight: bold; }

  .team-name { 
    text-align: left !important; 
    padding-left: 15px; 
    background: #eefaf8 !important; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    cursor: text; 
  }
  input { 
    width: 100%; 
    padding: 8px 4px; 
    border: none; 
    background: transparent; 
    font-weight: bold; 
    box-sizing: border-box; 
  }

  .legs, .diff { font-weight: bold; font-size: 1.1em !important; background: #f8f8f8; }
  .points { font-weight: bold; font-size: 1.2em; background: #e8f5e9; }

  #highestTable { 
    max-width: 800px; 
    margin: 40px auto; 
    border: 3px solid #8e44ad; 
    border-radius: 12px;
    overflow: hidden;
  }
  #highestTable th { background: #8e44ad; font-size: 1.4em; }
  #highestTable .score-row td { 
    font-size: 2.4em; 
    font-weight: bold; 
    color: #006f62; 
    background: #f0f8f7 !important; 
    height: 80px;
  }

  /* BUTTONS — ALL SAME STYLE */
  .action-btn {
    margin: 10px 8px;
    padding: 14px 28px;
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    min-width: 190px;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  .action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  }

  #addTeamBtn   { background: #2980b9; }
  #undoBtn      { background: #e74c3c; }
  #redoBtn      { background: #9b59b6; }
  #saveCsvBtn   { background: #27ae60; }
  #savePdfBtn   { background: linear-gradient(45deg, #e67e22, #f39c12); }
  #shareBtn     { background: #25D366; } /* WhatsApp green */

  #undoBtn:disabled, #redoBtn:disabled {
    background: #95a5a6 !important;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none;
  }

  .save-status { text-align: center; color: #0a0; font-weight: bold; margin: 10px 0; font-size: 1.1em; }
  .history-info { text-align: center; color: #555; font-size: 0.9em; margin-top: 5px; }

  #pdfContent { display: none; background: white; padding: 40px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h1>Byfield Skittles League Table</h1>
<div class="save-status" id="status">All changes saved automatically</div>
<div class="history-info" id="historyInfo">No changes to undo/redo</div>

<div class="table-container">
  <table id="leagueTable">
    <thead>
      <tr><th>Team</th><th>P</th><th>W</th><th>L</th><th>D</th><th>Legs +</th><th>Legs -</th><th>Diff</th><th>Pts</th></tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- BUTTON ROW -->
<div style="text-align:center;">
  <button class="action-btn" id="addTeamBtn" onclick="addTeam()">+ Add New Team</button>
  <button class="action-btn" id="undoBtn" onclick="undo()" disabled>Undo</button>
  <button class="action-btn" id="redoBtn" onclick="redo()" disabled>Redo</button>
  <button class="action-btn" id="saveCsvBtn" onclick="saveAsCSV()">Save as CSV</button>
  <button class="action-btn" id="savePdfBtn" onclick="saveAsPDF()">Save as PDF</button>
  <button class="action-btn" id="shareBtn" onclick="shareTable()">Share via WhatsApp</button>
</div>

<h2>Highest Score Board</h2>
<div class="table-container">
  <table id="highestTable">
    <thead>
      <tr><th colspan="2">Ladies</th><th colspan="2">Mens</th></tr>
      <tr><th>Name</th><th>Club</th><th>Name</th><th>Club</th></tr>
    </thead>
    <tbody>
      <tr class="score-row">
        <td colspan="2" contenteditable="true" id="ladies-score">17</td>
        <td colspan="2" contenteditable="true" id="mens-score">0</td>
      </tr>
      <tr>
        <td contenteditable="true" data-field="l-name-1">M. Watson</td>
        <td contenteditable="true" data-field="l-club-1">GNBL Club</td>
        <td contenteditable="true" data-field="m-name-1">E. Oliver</td>
        <td contenteditable="true" data-field="m-club-1">Long Buckby Club</td>
      </tr>
      <tr>
        <td contenteditable="true" data-field="l-name-2">M. Elcock</td>
        <td contenteditable="true" data-field="l-club-2">White Horse</td>
        <td contenteditable="true" data-field="m-name-2"></td>
        <td contenteditable="true" data-field="m-club-2"></td>
      </tr>
      <tr>
        <td contenteditable="true" data-field="l-name-3">G. Stanford</td>
        <td contenteditable="true" data-field="l-club-3">GNBL Club</td>
        <td contenteditable="true" data-field="m-name-3"></td>
        <td contenteditable="true" data-field="m-club-3"></td>
      </tr>
      <tr>
        <td contenteditable="true" data-field="l-name-4"></td>
        <td contenteditable="true" data-field="l-club-4"></td>
        <td contenteditable="true" data-field="m-name-4"></td>
        <td contenteditable="true" data-field="m-club-4"></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Hidden PDF content -->
<div id="pdfContent">
  <h1 style="text-align:center;color:#00332e;margin-bottom:30px;">Byfield Skittles League Table</h1>
  <div id="pdfLeagueTable"></div>
  <h2 style="text-align:center;color:#006f62;margin:50px 0 20px;">Highest Score Board</h2>
  <div id="pdfHighestTable"></div>
</div>

<script>
// ==================== SHARE VIA WHATSAPP / SMS ====================
function shareTable() {
  const now = new Date();
  const dateStr = now.toLocaleDateString('en-GB');
  const timeStr = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});

  let message = `*BYFIELD SKITTLES LEAGUE TABLE*%0A`;
  message += `Updated: ${dateStr} at ${timeStr}%0A%0A`;

  teams.forEach((team, i) => {
    const pos = (i + 1).toString().padStart(2);
    const pts = team.w * 2 + team.d;
    message += `${pos}. ${team.name} — ${pts} pts (${team.p} played)%0A`;
  });

  message += `%0A`;
  message += `Highest Ladies: ${document.getElementById('ladies-score').textContent.trim()} pins%0A`;
  message += `Highest Mens: ${document.getElementById('mens-score').textContent.trim()} pins%0A%0A`;
  message += `Live table: ${window.location.href}`;

  // Mobile (Android/iPhone)
  if (/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    // Try WhatsApp first, fall back to SMS
    window.location.href = `whatsapp://send?text=${message}`;
    setTimeout(() => {
      if (!document.hidden) {
        window.location.href = `sms:?body=${message}`;
      }
    }, 1000);
  } else {
    // Desktop — copy to clipboard
    const cleanMessage = message.replace(/%0A/g, '\n').replace(/%20/g, ' ');
    navigator.clipboard.writeText(cleanMessage).then(() => {
      document.getElementById('status').textContent = 'Table copied! Paste into WhatsApp';
      setTimeout(() => document.getElementById('status').textContent = 'All changes saved automatically', 4000);
    });
  }
}

// ==================== ALL YOUR ORIGINAL CODE (100% WORKING) ====================

const originalTeams = [
  { name: "Peppermill 'A'", p:11, w:9, l:2, d:0, lf:399, la:324 },
  { name: "Silverstone", p:11, w:8, l:2, d:1, lf:401, la:342 },
  { name: "White Horse Norton", p:10, w:6, l:4, d:0, lf:338, la:311 },
  { name: "Greens Norton BL Club", p:11, w:6, l:5, d:0, lf:361, la:369 },
  { name: "Wheatsheaf", p:10, w:5, l:4, d:1, lf:332, la:321 },
  { name: "Peppermill 'B'", p:10, w:5, l:5, d:0, lf:344, la:333 },
  { name: "Live and Let Live", p:10, w:5, l:5, d:0, lf:320, la:333 },
  { name: "Long Buckby Social", p:11, w:4, l:7, d:0, lf:370, la:395 },
  { name: "Daventry Workers", p:11, w:4, l:7, d:0, lf:352, la:388 },
  { name: "Napton Victory Club", p:10, w:3, l:7, d:0, lf:298, la:367 },
  { name: "Kings Arms", p:11, w:2, l:9, d:0, lf:347, la:379 }
];

let teams = JSON.parse(localStorage.getItem('byfieldSkittlesLeague')) || JSON.parse(JSON.stringify(originalTeams));
let history = [];
let future = [];
let isUndoing = false;

function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

function saveToHistory() {
  if (isUndoing) return;
  history.push(deepClone(teams));
  future = [];
  updateHistoryButtons();
}

function applyState(newTeams) {
  teams = deepClone(newTeams);
  localStorage.setItem('byfieldSkittlesLeague', JSON.stringify(teams));
  renderTable();
}

function undo() {
  if (history.length === 0) return;
  isUndoing = true;
  future.push(deepClone(teams));
  applyState(history.pop());
  updateHistoryButtons();
  document.getElementById('status').textContent = 'Undone!';
  setTimeout(() => document.getElementById('status').textContent = 'All changes saved automatically', 2000);
  isUndoing = false;
}

function redo() {
  if (future.length === 0) return;
  isUndoing = true;
  history.push(deepClone(teams));
  applyState(future.pop());
  updateHistoryButtons();
  document.getElementById('status').textContent = 'Redone!';
  setTimeout(() => document.getElementById('status').textContent = 'All changes saved automatically', 2000);
  isUndoing = false;
}

function updateHistoryButtons() {
  document.getElementById('undoBtn').disabled = history.length === 0;
  document.getElementById('redoBtn').disabled = future.length === 0;
  const info = document.getElementById('historyInfo');
  info.textContent = history.length || future.length 
    ? `${history.length} undo • ${future.length} redo` 
    : "No changes to undo/redo";
}

// Highest scores
let highestScores = JSON.parse(localStorage.getItem('byfieldHighestScores')) || {
  "ladies-score": "17", "mens-score": "0",
  "l-name-1": "M. Watson", "l-club-1": "GNBL Club",
  "l-name-2": "M. Elcock", "l-club-2": "White Horse",
  "l-name-3": "G. Stanford", "l-club-3": "GNBL Club",
  "m-name-1": "E. Oliver", "m-club-1": "Long Buckby Club"
};

Object.keys(highestScores).forEach(key => {
  const el = document.querySelector(`#${key}`) || document.querySelector(`[data-field="${key}"]`);
  if (el) el.textContent = highestScores[key];
});

document.querySelectorAll('#highestTable [contenteditable]').forEach(cell => {
  cell.addEventListener('blur', function() {
    const key = this.id || this.dataset.field;
    highestScores[key] = this.textContent.trim();
    localStorage.setItem('byfieldHighestScores', JSON.stringify(highestScores));
  });
});

function recalculateTeam(t) { t.p = t.w + t.l + t.d; return t; }
teams = teams.map(recalculateTeam);

function renderTable() {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  teams.forEach((team, i) => {
    const diff = team.lf - team.la;
    const pts  = team.w * 2 + team.d;
    tbody.innerHTML += `
      <tr>
        <td class="team-name" contenteditable="true" data-index="${i}">${team.name}</td>
        <td><input type="number" min="0" data-index="${i}" data-field="p" value="${team.p}" readonly style="background:#f0f0f0;"></td>
        <td><input type="number" min="0" data-index="${i}" data-field="w" value="${team.w}"></td>
        <td><input type="number" min="0" data-index="${i}" data-field="l" value="${team.l}"></td>
        <td><input type="number" min="0" data-index="${i}" data-field="d" value="${team.d}"></td>
        <td class="legs"><input type="number" min="0" data-index="${i}" data-field="lf" value="${team.lf}"></td>
        <td class="legs"><input type="number" min="0" data-index="${i}" data-field="la" value="${team.la}"></td>
        <td class="diff">${diff}</td>
        <td class="points">${pts}</td>
      </tr>`;
  });
}

document.getElementById('leagueTable').addEventListener('input', e => {
  if (isUndoing) return;
  saveToHistory();
  
  const cell = e.target;
  const i = parseInt(cell.dataset.index);
  if (isNaN(i)) return;
  
  if (cell.classList.contains('team-name')) {
    teams[i].name = cell.textContent.trim();
  } else {
    teams[i][cell.dataset.field] = parseInt(cell.value) || 0;
    if (['w','l','d'].includes(cell.dataset.field)) teams[i] = recalculateTeam(teams[i]);
  }
  
  localStorage.setItem('byfieldSkittlesLeague', JSON.stringify(teams));
  renderTable();
});

function addTeam() { 
  saveToHistory();
  teams.push(recalculateTeam({name:"New Team",p:0,w:0,l:0,d:0,lf:0,la:0})); 
  renderTable();
}

function saveAsCSV() {
  let csv = "Team,Played,Wins,Losses,Draws,Legs For,Legs Against,Diff,Points\n";
  teams.forEach(team => {
    const diff = team.lf - team.la;
    const points = team.w * 2 + team.d;
    csv += `"${team.name.replace(/"/g, '""')}",${team.p},${team.w},${team.l},${team.d},${team.lf},${team.la},${diff},${points}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", `Byfield_Skittles_${new Date().toISOString().slice(0,10)}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function saveAsPDF() {
  document.getElementById('status').textContent = 'Creating PDF...';
  const leagueClone = document.querySelector('#leagueTable').closest('.table-container').cloneNode(true);
  const highestClone = document.querySelector('#highestTable').closest('.table-container').cloneNode(true);
  document.getElementById('pdfLeagueTable').innerHTML = leagueClone.innerHTML;
  document.getElementById('pdfHighestTable').innerHTML = highestClone.innerHTML;

  document.querySelectorAll('body > *').forEach(el => el.style.display = 'none');
  document.getElementById('pdfContent').style.display = 'block';

  html2canvas(document.getElementById('pdfContent'), {scale: 2, backgroundColor: 'white'}).then(canvas => {
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const width = pdf.internal.pageSize.getWidth();
    const height = (canvas.height * width) / canvas.width;
    pdf.addImage(img, 'PNG', 10, 10, width-20, height);
    pdf.save(`Byfield_Skittles_${new Date().toISOString().slice(0,10)}.pdf`);

    document.querySelectorAll('body > *').forEach(el => el.style.display = '');
    document.getElementById('pdfContent').style.display = 'none';
    document.getElementById('status').textContent = 'PDF saved!';
    setTimeout(() => document.getElementById('status').textContent = 'All changes saved automatically', 3000);
  });
}

// Initialise
history.push(deepClone(originalTeams));
applyState(teams);
updateHistoryButtons();
renderTable();
</script>

<p style="text-align:center; color:#555; margin-top:40px; font-size:0.95rem;">
  Full Undo/Redo • Save as CSV • Save as PDF • Share via WhatsApp/SMS<br>
  All data saved automatically • Works perfectly on phone, tablet & computer
</p>
</body>
</html>